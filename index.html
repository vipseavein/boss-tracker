<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Boss Tracker - Cabal Online Ultimate Combo (SEA)</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">

<style>
/* ====== UI GIỮ NGUYÊN ====== */
body {
  font-family: Arial, sans-serif;
  background: #0d1117;
  color: #e6edf3;
  padding: 20px;
}
h2 {
  text-align: center;
  color: #58a6ff;
  text-shadow: 0 0 10px #58a6ff;
}
table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}
th, td {
  border: 1px solid rgba(88,166,255,0.2);
  padding: 4px;
  text-align: center;
  white-space: nowrap;
}
th {
  background: rgba(88,166,255,0.15);
  color: #58a6ff;
}
.channel-col { width: 60px; }

input[type="checkbox"] {
  transform: scale(1.5);
  cursor: pointer;
  accent-color: #58a6ff;
}

.timer {
  font-weight: bold;
  margin-left: 6px;
  padding: 2px 6px;
  border-radius: 4px;
  min-width: 50px;
  display: inline-block;
}

.blue { background:#0077ff;color:#fff }
.green{ background:#00cc44;color:#000 }
.yellow{background:#ffcc00;color:#000 }
.red{ background:#ff0033;color:#fff }

.right-clicked {
  outline: 3px solid #ffeb3b;
  box-shadow: 0 0 10px #ffeb3b;
}

.highlight-row td { background: rgba(255,255,255,0.08)!important }
.highlight-col { background: rgba(255,255,255,0.12)!important }

#notifications div {
  width: 60%;
  margin: 6px auto;
  padding: 8px;
  border-radius: 6px;
  font-weight: bold;
}

#themeToggle, #logButton {
  position: fixed;
  right: 20px;
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}
#themeToggle { bottom:20px; background:#58a6ff;color:#fff }
#logButton { bottom:60px; background:#ff9800;color:#fff }
</style>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>

<body>

<audio id="alertSound">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<h2>Boss Tracker - Cabal Ultimate Combo (SEA)</h2>
<table id="bossTable"></table>
<div id="notifications"></div>

<button id="themeToggle">Light Mode</button>
<button id="logButton">LOG</button>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBXdf1nQabS_5tt2gpIxDxo2w14KVsyL8g",
  authDomain: "boss-tracker-9e069.firebaseapp.com",
  databaseURL: "https://boss-tracker-9e069-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = firebase.database();

/* ===== SERVER TIME ===== */
let serverOffset = 0;
db.ref(".info/serverTimeOffset").on("value", s => serverOffset = s.val()||0);
const now = () => Date.now() + serverOffset;

/* ================= TABLE ================= */
const bosses = ["Manticore","Dark Kimzark","Minisha","Pluma","Pena Top","Pena Bot","Quadra","Tank Top","Tank Bot","Cây","Sói","Bò","Cauda"];
const table = document.getElementById("bossTable");
const notifications = document.getElementById("notifications");

let html = "<tr><th class='channel-col'>CH</th>";
bosses.forEach(b=>html+=`<th>${b}</th>`); html+="</tr>";
table.innerHTML = html;

for(let ch=1;ch<=30;ch++){
  let row = `<tr><td class="channel-col">${ch}</td>`;
  bosses.forEach(b=>{
    const id=`${ch}_${b}`;
    row+=`<td><input type="checkbox" id="${id}">
    <span class="timer" id="t_${id}">--</span></td>`;
  });
  row+="</tr>";
  table.insertAdjacentHTML("beforeend",row);
}

/* ================= HIGHLIGHT (TỐI ƯU) ================= */
let lastCell=null;
table.addEventListener("mouseover",e=>{
  const cell=e.target.closest("td,th");
  if(!cell||cell===lastCell)return;
  lastCell=cell;

  table.querySelectorAll(".highlight-row").forEach(r=>r.classList.remove("highlight-row"));
  table.querySelectorAll(".highlight-col").forEach(c=>c.classList.remove("highlight-col"));

  const col=cell.cellIndex,row=cell.parentElement;
  row.classList.add("highlight-row");
  [...table.rows].forEach(r=>r.cells[col]?.classList.add("highlight-col"));
});

/* ================= TIMERS (GLOBAL) ================= */
const timersData = {};
let globalTimer = null;

function startGlobalTimer(){
  if(globalTimer) return;
  globalTimer=setInterval(()=>{
    const current=now();
    updateNotifications(current);

    Object.entries(timersData).forEach(([id,d])=>{
      if(!d.checked)return;
      const cell=document.getElementById("t_"+id);
      if(!cell)return;

      const remain=240*60-Math.floor((current-d.startTime)/1000);
      if(remain<=0){
        cell.textContent="_SoS_";
        cell.className="timer red";
        return;
      }
      const mm=String(Math.floor(remain/60)).padStart(2,"0");
      const ss=String(remain%60).padStart(2,"0");
      cell.textContent=`${mm}:${ss}`;
      cell.className="timer "+
        (remain>=235*60?"blue":remain>5*60?"green":remain>3*60?"yellow":"red");
    });
  },1000);
}

/* ================= NOTIFICATIONS ================= */
function updateNotifications(current){
  const list=[];
  Object.entries(timersData).forEach(([id,d])=>{
    if(!d.checked)return;
    const r=240*60-Math.floor((current-d.startTime)/1000);
    if(r<=0)return;
    const [ch,b]=id.split("_");
    list.push({ch,b,r});
  });

  list.sort((a,b)=>a.r-b.r);
  notifications.innerHTML="";
  list.slice(0,5).forEach(i=>{
    const div=document.createElement("div");
    div.textContent=`Kênh ${i.ch} - Boss ${i.b} - Còn ${Math.floor(i.r/60)}:${String(i.r%60).padStart(2,"0")}`;
    div.className=i.r>=235*60?"blue":i.r>5*60?"green":i.r>3*60?"yellow":"red";
    notifications.appendChild(div);
  });
}

/* ================= FIREBASE SYNC ================= */
db.ref("timers").on("child_added",s=>{
  timersData[s.key]=s.val();
  startGlobalTimer();
});
db.ref("timers").on("child_changed",s=>timersData[s.key]=s.val());
db.ref("timers").on("child_removed",s=>{
  delete timersData[s.key];
  const c=document.getElementById("t_"+s.key);
  if(c)c.textContent="--";
});

/* ================= CHECKBOX EVENTS ================= */
bosses.forEach(b=>{
  for(let ch=1;ch<=30;ch++){
    const id=`${ch}_${b}`;
    const cb=document.getElementById(id);

    cb.addEventListener("change",e=>{
      e.target.checked
        ? db.ref("timers/"+id).set({checked:true,startTime:now()})
        : db.ref("timers/"+id).remove();
    });

    cb.addEventListener("contextmenu",e=>{
      e.preventDefault();
      const ref=db.ref("colors/"+id);
      ref.once("value").then(s=>s.exists()?ref.remove():ref.set(true));
    });
  }
});

/* ================= COLORS (INCREMENTAL) ================= */
db.ref("colors").on("child_added",s=>{
  document.getElementById(s.key)?.classList.add("right-clicked");
});
db.ref("colors").on("child_removed",s=>{
  document.getElementById(s.key)?.classList.remove("right-clicked");
});

/* ================= BUTTONS ================= */
document.getElementById("logButton").onclick=()=>location.href="log.html";
</script>
</body>
</html>
