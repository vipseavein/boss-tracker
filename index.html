<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Boss Tracker - Cabal Online Ultimate Combo (SEA)</title>
<link rel="icon" href="favicon.ico">
<style>
body{font-family:Arial,sans-serif;background:#0d1117;color:#e6edf3;padding:20px}
h2{text-align:center;color:#58a6ff}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid rgba(88,166,255,.2);padding:4px;text-align:center}
.timer{font-weight:bold;padding:2px 6px;border-radius:4px;min-width:70px;display:inline-block}
.blue{background:#0077ff;color:#fff}
.green{background:#00cc44;color:#000}
.yellow{background:#ffcc00;color:#000}
.red{background:#ff0033;color:#fff}
</style>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>

<body>

<audio id="alertSound">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<h2>Boss Tracker - Cabal Ultimate Combo (SEA)</h2>
<table id="bossTable"></table>
<div id="notifications"></div>

<script>
/* ---------- FIREBASE ---------- */
firebase.initializeApp({
  apiKey:"AIzaSyBXdf1nQabS_5tt2gpIxDxo2w14KVsyL8g",
  databaseURL:"https://boss-tracker-9e069-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=firebase.database();

/* ---------- SERVER TIME ---------- */
let serverOffset=0;
db.ref(".info/serverTimeOffset").on("value",s=>serverOffset=s.val()||0);
function now(){return Date.now()+serverOffset}

/* ---------- DATA ---------- */
const bosses=["Manticore","Dark Kimzark","Minisha","Pluma","Pena Top","Pena Bot","Quadra","Tank Top","Tank Bot","Cây","Sói","Bò","Cauda"];
const table=document.getElementById("bossTable");

/* ---------- TABLE ---------- */
let head="<tr><th>Channel</th>";
bosses.forEach(b=>head+=`<th>${b}</th>`);
head+="</tr>";
table.innerHTML=head;

for(let ch=1;ch<=30;ch++){
  let r=`<tr><td>${ch}</td>`;
  bosses.forEach(b=>{
    const id=`${ch}_${b}`;
    r+=`<td>
      <input type="checkbox" id="${id}">
      <div class="timer" id="t_${id}">--</div>
    </td>`;
  });
  r+="</tr>";
  table.insertAdjacentHTML("beforeend",r);
}

/* ---------- UTILS ---------- */
function fmt(sec){
  const m=String(Math.floor(sec/60)).padStart(2,"0");
  const s=String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}

/* ---------- TIMER ---------- */
let globalTick=null;
function ensureGlobalTick(){
  if(globalTick)return;
  globalTick=setInterval(()=>{
    document.querySelectorAll(".timer[data-start]").forEach(cell=>{
      const start=+cell.dataset.start;
      let remain=240*60-Math.floor((now()-start)/1000);

      /* === CHẠM 0 → KÍCH HOẠT SOS + RESET === */
      if(remain<=0 && !cell.dataset.sos){
        cell.dataset.sos="1";
        cell.dataset.sosStart=now();

        const id=cell.id.replace("t_","");
        db.ref("timers/"+id).update({startTime:now()});

        try{document.getElementById("alertSound").play()}catch(e){}
        remain=240*60;
      }

      const text=fmt(Math.max(0,remain));

      /* === ĐANG SOS === */
      if(cell.dataset.sos){
        if(now()-cell.dataset.sosStart>=300000){
          delete cell.dataset.sos;
          delete cell.dataset.sosStart;
        }else{
          const blink=Math.floor(now()/1000)%2===0;
          cell.textContent=blink?"_SoS_":text;
          cell.className="timer red";
          return;
        }
      }

      /* === NORMAL === */
      cell.textContent=text;
      cell.className="timer";
      cell.classList.add(
        remain>=235*60?"blue":
        remain>5*60?"green":
        remain>3*60?"yellow":"red"
      );
    });
  },1000);
}

function startTimer(id,start){
  const cell=document.getElementById("t_"+id);
  cell.dataset.start=start;
  delete cell.dataset.sos;
  delete cell.dataset.sosStart;
  ensureGlobalTick();
}

function stopTimer(id){
  const cell=document.getElementById("t_"+id);
  delete cell.dataset.start;
  delete cell.dataset.sos;
  delete cell.dataset.sosStart;
  cell.textContent="--";
  cell.className="timer";
}

/* ---------- FIREBASE SYNC ---------- */
db.ref("timers").on("child_added",s=>{
  if(s.val().checked)startTimer(s.key,s.val().startTime);
});
db.ref("timers").on("child_changed",s=>{
  if(s.val().checked)startTimer(s.key,s.val().startTime);
});
db.ref("timers").on("child_removed",s=>stopTimer(s.key));

/* ---------- EVENTS ---------- */
bosses.forEach(b=>{
  for(let ch=1;ch<=30;ch++){
    const id=`${ch}_${b}`;
    const cb=document.getElementById(id);
    const cell=document.getElementById("t_"+id);

    cb.onchange=e=>{
      if(e.target.checked){
        db.ref("timers/"+id).set({checked:true,startTime:now()});
      }else{
        db.ref("timers/"+id).remove();
      }
    };

    cell.onclick=()=>{
      if(cell.dataset.sos){
        delete cell.dataset.sos;
        delete cell.dataset.sosStart;
      }
    };
  }
});
</script>

</body>
</html>
