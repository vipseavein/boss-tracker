<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Boss Tracker - Cabal Online Ultimate Combo (SEA)</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">

<style>
body {
  font-family: Arial, sans-serif;
  background: #0d1117;
  color: #e6edf3;
  padding: 20px;
}

h2 {
  text-align: center;
  color: #58a6ff;
  text-shadow: 0 0 10px #58a6ff;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: rgba(255,255,255,0.03);
}

th, td {
  border: 1px solid rgba(88,166,255,0.2);
  padding: 4px;
  text-align: center;
}

input[type="checkbox"] {
  transform: scale(1.5);
  cursor: pointer;
  accent-color: #58a6ff;
}

/* Chuột phải */
.right-clicked {
  outline: 3px solid #ffeb3b !important;
  box-shadow: 0 0 10px #ffeb3b;
  border-radius: 4px;
}

.timer {
  margin-left: 6px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: bold;
}

.blue { background:#0077ff; color:white; }
.green { background:#00cc44; color:black; }
.yellow { background:#ffcc00; color:black; }
.red { background:#ff0033; color:white; }
</style>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>

<body>

<audio id="alertSound">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<h2>Boss Tracker - Cabal Ultimate Combo (SEA)</h2>
<table id="bossTable"></table>

<script>
/* Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyBXdf1nQabS_5tt2gpIxDxo2w14KVsyL8g",
  authDomain: "boss-tracker-9e069.firebaseapp.com",
  databaseURL: "https://boss-tracker-9e069-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = firebase.database();

const bosses = ["Manticore","Dark Kimzark","Minisha","Pluma","Pena Top","Pena Bot","Quadra","Tank Top","Tank Bot","Cây","Sói","Bò","Cauda"];
const table = document.getElementById("bossTable");

/* Tạo bảng */
let header = "<tr><th>Channel</th>";
bosses.forEach(b => header += `<th>${b}</th>`);
header += "</tr>";
table.innerHTML = header;

for (let ch = 1; ch <= 30; ch++) {
  let row = `<tr><td>${ch}</td>`;
  bosses.forEach(boss => {
    const id = `${ch}_${boss}`;
    row += `<td>
      <input type="checkbox" id="${id}">
      <span class="timer" id="t_${id}">--</span>
    </td>`;
  });
  row += "</tr>";
  table.insertAdjacentHTML("beforeend", row);
}

/* Checkbox logic */
bosses.forEach(boss => {
  for (let ch = 1; ch <= 30; ch++) {

    const id = `${ch}_${boss}`;
    const checkbox = document.getElementById(id);
    const timerCell = document.getElementById("t_"+id);

    /* Chuột trái */
    checkbox.addEventListener("change", e => {
      if (e.target.checked) {
        db.ref("timers/"+id).set({
          checked: true,
          startTime: Date.now()
        });
      } else {
        db.ref("timers/"+id).remove();
      }
    });

    /* Chuột phải – ĐỘC LẬP TIMER */
    checkbox.addEventListener("contextmenu", e => {
      e.preventDefault();
      const colorRef = db.ref("colors/"+id);

      colorRef.once("value").then(snap => {
        if (snap.exists()) colorRef.remove();
        else colorRef.set(true);
      });
    });

    /* Chuột phải timer – chỉnh phút */
    timerCell.addEventListener("contextmenu", e => {
      e.preventDefault();
      const input = prompt("Nhập số phút:");
      if (!input) return;

      const min = parseInt(input);
      if (isNaN(min) || min <= 0) return;

      const start = Date.now() - (240*60 - min*60)*1000;
      db.ref("timers/"+id).set({checked:true,startTime:start});
    });
  }
});

/* Đồng bộ MÀU – reset rồi apply */
db.ref("colors").on("value", snap => {
  document.querySelectorAll("input[type='checkbox']")
    .forEach(cb => cb.classList.remove("right-clicked"));

  const data = snap.val() || {};
  Object.keys(data).forEach(id => {
    const cb = document.getElementById(id);
    if (cb) cb.classList.add("right-clicked");
  });
});

/* Countdown */
db.ref("timers").on("value", snap => {
  const data = snap.val() || {};

  document.querySelectorAll(".timer").forEach(t => {
    if (t.intervalId) {
      clearInterval(t.intervalId);
      t.intervalId = null;
    }
  });

  Object.keys(data).forEach(id => {
    const {checked,startTime} = data[id];
    const timer = document.getElementById("t_"+id);
    const cb = document.getElementById(id);

    if (!timer || !cb) return;
    cb.checked = checked;

    if (!checked) {
      timer.textContent="--";
      timer.className="timer";
      return;
    }

    timer.intervalId = setInterval(() => {
      const remain = 240*60 - Math.floor((Date.now()-startTime)/1000);
      if (remain <= 0) {
        timer.textContent="_SoS_";
        timer.className="timer red";
        try{document.getElementById("alertSound").play();}catch(e){}
        clearInterval(timer.intervalId);
        return;
      }

      const mm = String(Math.floor(remain/60)).padStart(2,"0");
      const ss = String(remain%60).padStart(2,"0");
      timer.textContent = `${mm}:${ss}`;
      timer.className="timer";

      if (remain >= 235*60) timer.classList.add("blue");
      else if (remain > 5*60) timer.classList.add("green");
      else if (remain > 3*60) timer.classList.add("yellow");
      else timer.classList.add("red");
    },1000);
  });
});
</script>
</body>
</html>
