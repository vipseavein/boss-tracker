<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Boss Tracker - Cabal Online Ultimate Combo (SEA)</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0d1117;
      color: #e6edf3;
      padding: 20px;
      transition: 0.3s;
    }

    h2 {
      text-align: center;
      color: #58a6ff;
      text-shadow: 0 0 10px #58a6ff;
      font-size: 28px;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      background: rgba(255,255,255,0.03);
    }

    th, td {
      border: 1px solid rgba(88,166,255,0.2);
      padding: 4px;
      text-align: center;
      color: #c9d1d9;
      white-space: nowrap;
    }

    th {
      background: rgba(88,166,255,0.15);
      color: #58a6ff;
    }

    input[type="checkbox"] {
      transform: scale(1.5);
      cursor: pointer;
      accent-color: #58a6ff;
    }

    .right-clicked {
      outline: 3px solid #ffeb3b;
      box-shadow: 0 0 10px #ffeb3b;
      border-radius: 4px;
    }

    .timer {
      font-weight: bold;
      display: inline-block;
      min-width: 55px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .blue { color: #58a6ff; }
    .green { color: #3fb950; }
    .yellow { color: #d29922; }
    .red { color: #f85149; }
  </style>
</head>

<body>
<h2>Boss Tracker - Cabal Online (SEA)</h2>
<table id="bossTable"></table>
<audio id="alertSound" src="alert.mp3" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* ================= FIREBASE INIT ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBXdf1nQabS_5tt2gpIxDxo2w14KVsyL8g",
  authDomain: "boss-tracker-9e069.firebaseapp.com",
  databaseURL: "https://boss-tracker-9e069-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "boss-tracker-9e069",
  storageBucket: "boss-tracker-9e069.appspot.com",
  messagingSenderId: "968667523286",
  appId: "1:968667523286:web:a8c750376cfe9df7310177"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= SERVER TIME ================= */
let serverOffset = 0;
db.ref(".info/serverTimeOffset").on("value", snap => {
  serverOffset = snap.val() || 0;
});
function now() {
  return Date.now() + serverOffset;
}

/* ================= DATA STORE ================= */
let timersData = {};

/* ================= CHECKBOX EVENT ================= */
document.addEventListener("change", e => {
  if (!e.target.matches("input[type='checkbox']")) return;
  const id = e.target.id;

  if (e.target.checked) {
    db.ref("timers/" + id).set({
      checked: true,
      startTime: now()
    });
  } else {
    db.ref("timers/" + id).remove();
  }
});

/* ================= FIREBASE SYNC ================= */
db.ref("timers").on("child_added", snap => {
  timersData[snap.key] = snap.val();
});

db.ref("timers").on("child_changed", snap => {
  timersData[snap.key] = snap.val();
});

db.ref("timers").on("child_removed", snap => {
  delete timersData[snap.key];
  const t = document.getElementById("t_" + snap.key);
  const c = document.getElementById(snap.key);
  if (t) { t.textContent = "--"; t.className = "timer"; }
  if (c) c.checked = false;
});

/* ================= GLOBAL TICKER ================= */
setInterval(() => {
  const current = now();

  Object.keys(timersData).forEach(id => {
    const data = timersData[id];
    if (!data || !data.checked) return;

    const timerCell = document.getElementById("t_" + id);
    const checkbox = document.getElementById(id);
    if (!timerCell || !checkbox) return;

    checkbox.checked = true;

    const remain = 240*60 - Math.floor((current - data.startTime)/1000);

    if (remain <= 0) {
      timerCell.textContent = "_SoS_";
      timerCell.className = "timer red";
      try { document.getElementById("alertSound").play(); } catch(e){}
      return;
    }

    const mm = String(Math.floor(remain/60)).padStart(2,"0");
    const ss = String(remain%60).padStart(2,"0");
    timerCell.textContent = mm + ":" + ss;

    timerCell.className = "timer";
    if (remain >= 235*60) timerCell.classList.add("blue");
    else if (remain > 5*60) timerCell.classList.add("green");
    else if (remain > 3*60) timerCell.classList.add("yellow");
    else timerCell.classList.add("red");
  });
}, 1000);
</script>
</body>
</html>
